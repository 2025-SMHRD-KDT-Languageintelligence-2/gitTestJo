<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë§ì¶¤í˜• ì‹ë‹¨ ì¶”ì²œ ì„¤ë¬¸</title>
  <link rel="stylesheet" href="/css/preference-form.css" />
</head>
<body>
  <h1>ë§ì¶¤í˜• ì‹ë‹¨ ì¶”ì²œì„ ìœ„í•œ ì„¤ë¬¸</h1>

  <form id="surveyForm">

    <!-- ğŸ‘¤ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ hidden ì²˜ë¦¬ -->
    <input type="hidden" id="userId" th:value="${userId}">
    <input type="hidden" id="recomCal" th:value="${recomCal}">

    <!-- STEP 1 -->
    <div class="form-step active" id="step1">
      <h2>STEP 1: ì‹ì‚¬ ë° ì„ í˜¸ ì¬ë£Œ</h2>

      <div class="form-group">
        <p>ì„ í˜¸í•˜ëŠ” ë°¥ ì¢…ë¥˜</p>
        <div class="checkbox-grid">
          <label><input type="checkbox" name="preferredRiceTypes" value="ìŒ€ë°¥"> ìŒ€ë°¥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="ì¡ê³¡ë°¥"> ì¡ê³¡ë°¥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="í˜„ë¯¸ë°¥"> í˜„ë¯¸ë°¥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="í‘ë¯¸ë°¥"> í‘ë¯¸ë°¥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="ì°°ë°¥"> ì°°ë°¥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="ì°¨ì¡°ë°¥"> ì°¨ì¡°ë°¥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="ê·€ë¦¬ë°¥"> ê·€ë¦¬ë°¥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="ì˜¤ê³¡ë°¥"> ì˜¤ê³¡ë°¥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="ë³´ë¦¬ë°¥"> ë³´ë¦¬ë°¥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="ê²€ì •ì½©ë°¥"> ê²€ì •ì½©ë°¥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="ìˆ˜ìˆ˜ë°¥"> ìˆ˜ìˆ˜ë°¥</label>
        </div>
      </div>

      <div class="form-group">
        <p>ì„ í˜¸í•˜ëŠ” ì¡°ë¦¬ ë°©ì‹</p>
        <div class="checkbox-grid">
          <label><input type="checkbox" name="userTags" value="êµ­ë¬¼ìš”ë¦¬"> êµ­ë¬¼ìš”ë¦¬</label>
          <label><input type="checkbox" name="userTags" value="ë³¶ìŒìš”ë¦¬"> ë³¶ìŒìš”ë¦¬</label>
          <label><input type="checkbox" name="userTags" value="ì¡°ë¦¼ìš”ë¦¬"> ì¡°ë¦¼ìš”ë¦¬</label>
        </div>
      </div>

      <div class="form-group">
        <p>ì„ í˜¸í•˜ëŠ” ì¬ë£Œ</p>
        <div class="checkbox-grid">
          <label><input type="checkbox" name="userTags" value="ì†Œê³ ê¸°"> ì†Œê³ ê¸°</label>
          <label><input type="checkbox" name="userTags" value="ë¼ì§€ê³ ê¸°"> ë¼ì§€ê³ ê¸°</label>
          <label><input type="checkbox" name="userTags" value="ë‹­ê³ ê¸°"> ë‹­ê³ ê¸°</label>
          <label><input type="checkbox" name="userTags" value="ì˜¤ë¦¬ê³ ê¸°"> ì˜¤ë¦¬ê³ ê¸°</label>
          <label><input type="checkbox" name="userTags" value="ê°ì"> ê°ì</label>
          <label><input type="checkbox" name="userTags" value="ê³ êµ¬ë§ˆ"> ê³ êµ¬ë§ˆ</label>
          <label><input type="checkbox" name="userTags" value="ê³„ë€"> ê³„ë€</label>
          <label><input type="checkbox" name="userTags" value="ë‘ë¶€"> ë‘ë¶€</label>
          <label><input type="checkbox" name="userTags" value="ì½©"> ì½©</label>
          <label><input type="checkbox" name="userTags" value="ë²„ì„¯"> ë²„ì„¯</label>
          <label><input type="checkbox" name="userTags" value="ëŠíƒ€ë¦¬"> ëŠíƒ€ë¦¬</label>
          <label><input type="checkbox" name="userTags" value="í‘œê³ "> í‘œê³ </label>
          <label><input type="checkbox" name="userTags" value="ì–‘íŒŒ"> ì–‘íŒŒ</label>
          <label><input type="checkbox" name="userTags" value="ë‹¹ê·¼"> ë‹¹ê·¼</label>
          <label><input type="checkbox" name="userTags" value="ì˜¤ì´"> ì˜¤ì´</label>
          <label><input type="checkbox" name="userTags" value="ë¸Œë¡œì½œë¦¬"> ë¸Œë¡œì½œë¦¬</label>
          <label><input type="checkbox" name="userTags" value="ì–‘ë°°ì¶”"> ì–‘ë°°ì¶”</label>
          <label><input type="checkbox" name="userTags" value="ê°€ì§€"> ê°€ì§€</label>
          <label><input type="checkbox" name="userTags" value="ì• í˜¸ë°•"> ì• í˜¸ë°•</label>
          <label><input type="checkbox" name="userTags" value="ë¯¸ì—­"> ë¯¸ì—­</label>
          <label><input type="checkbox" name="userTags" value="ë©¸ì¹˜"> ë©¸ì¹˜</label>
          <label><input type="checkbox" name="userTags" value="ì—°ê·¼"> ì—°ê·¼</label>
          <label><input type="checkbox" name="userTags" value="ìš°ì—‰"> ìš°ì—‰</label>
          <label><input type="checkbox" name="userTags" value="ìš°ê±°ì§€"> ìš°ê±°ì§€</label>
          <label><input type="checkbox" name="userTags" value="ìƒˆìš°"> ìƒˆìš°</label>
          <label><input type="checkbox" name="userTags" value="ë‚™ì§€"> ë‚™ì§€</label>
          <label><input type="checkbox" name="userTags" value="ë¬¸ì–´"> ë¬¸ì–´</label>
          <label><input type="checkbox" name="userTags" value="ì˜¤ì§•ì–´"> ì˜¤ì§•ì–´</label>
          <label><input type="checkbox" name="userTags" value="êµ´"> êµ´</label>
          <label><input type="checkbox" name="userTags" value="ì°¸ì¹˜"> ì°¸ì¹˜</label>
        </div>
      </div>

      <div class="navigation">
        <button type="button" onclick="goToStep(2)">ë‹¤ìŒ</button>
      </div>
    </div>

    <!-- STEP 2 -->
    <div class="form-step" id="step2">
      <h2>STEP 2: ê¸°í”¼ ìŒì‹ ë° ì¹¼ë¡œë¦¬ ë¶„ë°°</h2>

      <div class="form-group">
        <p>ê¸°í”¼í•˜ëŠ” ì¡°ë¦¬ íŠ¹ì„±</p>
        <div class="checkbox-grid">
          <label><input type="checkbox" name="dislikedTags" value="ë§¤ìš´ë§›"> ë§¤ìš´ë§›</label>
          <label><input type="checkbox" name="dislikedTags" value="ë°œíš¨êµ­"> ë°œíš¨ëœ êµ­ë¬¼</label>
          <label><input type="checkbox" name="dislikedTags" value="ê³ ë‹¹"> ë‹¹ë¶„ì´ ë†’ì€ ìŒì‹</label>
          <label><input type="checkbox" name="dislikedTags" value="ê³ ì§€ë°©"> ì§€ë°©ì´ ë§ì€ ìŒì‹</label>
          <label><input type="checkbox" name="dislikedTags" value="ê³ ì¹¼ë¡œë¦¬"> ê³ ì¹¼ë¡œë¦¬ ìŒì‹</label>
        </div>
      </div>

      <div class="form-group">
        <p>ê¸°í”¼í•˜ëŠ” ì¬ë£Œ</p>
        <div class="checkbox-grid">
          <!-- ê°™ì€ ë°©ì‹ìœ¼ë¡œ ë°˜ë³µ -->
          <label><input type="checkbox" name="dislikedTags" value="ì†Œê³ ê¸°"> ì†Œê³ ê¸°</label>
          <label><input type="checkbox" name="dislikedTags" value="ë¼ì§€ê³ ê¸°"> ë¼ì§€ê³ ê¸°</label>
          <label><input type="checkbox" name="dislikedTags" value="ë‹­ê³ ê¸°"> ë‹­ê³ ê¸°</label>
          <label><input type="checkbox" name="dislikedTags" value="ì˜¤ë¦¬ê³ ê¸°"> ì˜¤ë¦¬ê³ ê¸°</label>
          <label><input type="checkbox" name="dislikedTags" value="ê°ì"> ê°ì</label>
          <label><input type="checkbox" name="dislikedTags" value="ê³ êµ¬ë§ˆ"> ê³ êµ¬ë§ˆ</label>
          <label><input type="checkbox" name="dislikedTags" value="ê³„ë€"> ê³„ë€</label>
          <label><input type="checkbox" name="dislikedTags" value="ë‘ë¶€"> ë‘ë¶€</label>
          <label><input type="checkbox" name="dislikedTags" value="ì½©"> ì½©</label>
          <label><input type="checkbox" name="dislikedTags" value="ë²„ì„¯"> ë²„ì„¯</label>
          <label><input type="checkbox" name="dislikedTags" value="ëŠíƒ€ë¦¬"> ëŠíƒ€ë¦¬</label>
          <label><input type="checkbox" name="dislikedTags" value="í‘œê³ "> í‘œê³ </label>
          <label><input type="checkbox" name="dislikedTags" value="ì–‘íŒŒ"> ì–‘íŒŒ</label>
          <label><input type="checkbox" name="dislikedTags" value="ë‹¹ê·¼"> ë‹¹ê·¼</label>
          <label><input type="checkbox" name="dislikedTags" value="ì˜¤ì´"> ì˜¤ì´</label>
          <label><input type="checkbox" name="dislikedTags" value="ë¸Œë¡œì½œë¦¬"> ë¸Œë¡œì½œë¦¬</label>
          <label><input type="checkbox" name="dislikedTags" value="ì–‘ë°°ì¶”"> ì–‘ë°°ì¶”</label>
          <label><input type="checkbox" name="dislikedTags" value="ê°€ì§€"> ê°€ì§€</label>
          <label><input type="checkbox" name="dislikedTags" value="ì• í˜¸ë°•"> ì• í˜¸ë°•</label>
          <label><input type="checkbox" name="dislikedTags" value="ë¯¸ì—­"> ë¯¸ì—­</label>
          <label><input type="checkbox" name="dislikedTags" value="ë©¸ì¹˜"> ë©¸ì¹˜</label>
          <label><input type="checkbox" name="dislikedTags" value="ì—°ê·¼"> ì—°ê·¼</label>
          <label><input type="checkbox" name="dislikedTags" value="ìš°ì—‰"> ìš°ì—‰</label>
          <label><input type="checkbox" name="dislikedTags" value="ìš°ê±°ì§€"> ìš°ê±°ì§€</label>
          <label><input type="checkbox" name="dislikedTags" value="ìƒˆìš°"> ìƒˆìš°</label>
          <label><input type="checkbox" name="dislikedTags" value="ë‚™ì§€"> ë‚™ì§€</label>
          <label><input type="checkbox" name="dislikedTags" value="ë¬¸ì–´"> ë¬¸ì–´</label>
          <label><input type="checkbox" name="dislikedTags" value="ì˜¤ì§•ì–´"> ì˜¤ì§•ì–´</label>
          <label><input type="checkbox" name="dislikedTags" value="êµ´"> êµ´</label>
          <label><input type="checkbox" name="dislikedTags" value="ì°¸ì¹˜"> ì°¸ì¹˜</label>
        </div>
      </div>

      <div class="navigation">
        <button type="button" onclick="goToStep(1)">ì´ì „</button>
        <button type="button" onclick="goToStep(3)">ë‹¤ìŒ</button>
      </div>
    </div>

    <!-- STEP 3 -->
    <div class="form-step" id="step3">
      <h2>STEP 3: ì¤‘ìš” ì˜ì–‘ ìš”ì†Œ + ì¹¼ë¡œë¦¬ ë¶„ë°°</h2>

      <div class="form-group">
        <p>ë‹¨ë°±ì§ˆ</p>
        <div class="checkbox-grid">
          <label><input type="radio" name="userTags_protein" value="ì €ë‹¨ë°±"> ì €ë‹¨ë°±</label>
          <label><input type="radio" name="userTags_protein" value="ì¤‘ë‹¨ë°±"> ì¤‘ë‹¨ë°±</label>
          <label><input type="radio" name="userTags_protein" value="ê³ ë‹¨ë°±"> ê³ ë‹¨ë°±</label>
        </div>
      </div>

      <div class="form-group">
        <p>ì§€ë°©</p>
        <div class="checkbox-grid">
          <label><input type="radio" name="userTags_fat" value="ì €ì§€ë°©"> ì €ì§€ë°©</label>
          <label><input type="radio" name="userTags_fat" value="ì¤‘ì§€ë°©"> ì¤‘ì§€ë°©</label>
          <label><input type="radio" name="userTags_fat" value="ê³ ì§€ë°©"> ê³ ì§€ë°©</label>
        </div>
      </div>

      <div class="form-group">
        <p>ë‹¹ë¥˜</p>
        <div class="checkbox-grid">
          <label><input type="radio" name="userTags_sugar" value="ì €ë‹¹"> ì €ë‹¹</label>
          <label><input type="radio" name="userTags_sugar" value="ì¤‘ê°„ë‹¹"> ì¤‘ê°„ë‹¹</label>
          <label><input type="radio" name="userTags_sugar" value="ê³ ë‹¹"> ê³ ë‹¹</label>
        </div>
      </div>

      <div class="form-group">
        <p>ì¹¼ë¡œë¦¬</p>
        <div class="checkbox-grid">
          <label><input type="radio" name="userTags_calorie" value="ì €ì¹¼ë¡œë¦¬"> ì €ì¹¼ë¡œë¦¬</label>
          <label><input type="radio" name="userTags_calorie" value="ì¤‘ê°„ì¹¼ë¡œë¦¬"> ì¤‘ê°„ì¹¼ë¡œë¦¬</label>
          <label><input type="radio" name="userTags_calorie" value="ê³ ì¹¼ë¡œë¦¬"> ê³ ì¹¼ë¡œë¦¬</label>
        </div>
      </div>

      <hr>

      <div class="form-group">
        <p>í•˜ë£¨ ì¹¼ë¡œë¦¬ ë¶„ë°° ë¹„ìœ¨ (%)</p>
        <label>ì•„ì¹¨:</label><input type="number" name="calRatioMorning" value="30" min="0" max="100"> %
        <label>ì ì‹¬:</label><input type="number" name="calRatioLunch" value="40" min="0" max="100"> %
        <label>ì €ë…:</label><input type="number" name="calRatioEvening" value="30" min="0" max="100"> %
      </div>

      <div class="navigation">
        <button type="button" onclick="goToStep(2)">ì´ì „</button>
        <button type="submit">ì œì¶œ</button>
      </div>
    </div>
  </form>

  <!-- âœ… ì¶”ì²œ ê²°ê³¼ ì¶œë ¥ ì˜ì—­ -->
  <div id="resultArea" style="max-width: 1000px; margin: 40px auto;"></div>

  <script>
    function goToStep(stepNum) {
      document.querySelectorAll(".form-step").forEach(div => {
        div.classList.remove("active");
      });
      document.getElementById(`step${stepNum}`).classList.add("active");
    }
  
    document.getElementById("surveyForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const getCheckedValues = (name) => {
        return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);
      };

      const formData = new FormData(this);

      const getRatio = (name, defaultVal) => {
        const val = formData.get(name);
        return val === null || val === "" ? defaultVal : parseInt(val);
      };

      // âœ… ë¼ë””ì˜¤ ê·¸ë£¹ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
      const getRadioValue = (name) => {
        const selected = document.querySelector(`input[name="${name}"]:checked`);
        return selected ? selected.value : null;
      };

      // âœ… userTags ì¡°í•© (ì²´í¬ë°•ìŠ¤ + ë¼ë””ì˜¤ê°’ í¬í•¨)
      const userTags = [
        ...getCheckedValues("userTags"), // checkbox ë°©ì‹ (ìš”ë¦¬ë°©ì‹, ì¬ë£Œ ë“±)
        getRadioValue("userTags_protein"),
        getRadioValue("userTags_fat"),
        getRadioValue("userTags_sugar"),
        getRadioValue("userTags_calorie")
      ].filter(Boolean); // null/undefined ì œê±°

      const data = {
        userId: document.getElementById("userId").value,
        recomCal: parseFloat(document.getElementById("recomCal").value),
        preferredRiceTypes: getCheckedValues("preferredRiceTypes"),
        userTags: userTags,
        dislikedTags: getCheckedValues("dislikedTags"),
        calRatioMorning: getRatio("calRatioMorning", 30),
        calRatioLunch: getRatio("calRatioLunch", 40),
        calRatioEvening: getRatio("calRatioEvening", 30)
      };

      console.log("ğŸ“¤ APIë¡œ ë³´ë‚¼ ë°ì´í„°:", data);

      try {
        const res = await fetch("http://127.0.0.1:8000/recommend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        const result = await res.json();
        console.log("âœ… ì¶”ì²œ ê²°ê³¼:", result);

        window.lastRecommendationResult = result;
        window.currentUserId = data.userId;

        renderResults(result);
      } catch (err) {
        console.error("âŒ ì¶”ì²œ ì‹¤íŒ¨:", err);
        alert("ì¶”ì²œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  
    function renderResults(data) {
      const container = document.getElementById("resultArea");
  
      let html = `
        <div class="recommend-wrapper">
          <h2 class="recommend-title">ğŸ± ì¶”ì²œ ì‹ë‹¨ ê²°ê³¼</h2>
          <table class="recommend-table">
            <thead>
              <tr>
                <th>ë‚ ì§œ</th>
                <th>ì•„ì¹¨</th>
                <th>ì ì‹¬</th>
                <th>ì €ë…</th>
              </tr>
            </thead>
            <tbody>
      `;
  
      const days = Array.from(new Set(data.map(d => d.day))).sort((a, b) => a - b);
      const times = ["morning", "lunch", "dinner"];
  
      for (let day of days) {
        html += `<tr><td>${day}ì¼ì°¨</td>`;
        for (let time of times) {
          const meal = data.find(m => m.day === day && m.time === time);
          if (meal) {
            html += `
              <td>
                <div><strong>ë°¥:</strong> ${meal.rice}</div>
                <div><strong>êµ­:</strong> ${meal.soup}</div>
                <div><strong>ë°˜ì°¬:</strong> ${meal.side}</div>
                <div><strong>ì¹¼ë¡œë¦¬:</strong> ${meal.totalCal} kcal</div>
                <div><strong>ìœ ì‚¬ë„:</strong> ${meal.similarity}</div>
              </td>
            `;
          } else {
            html += `<td>-</td>`;
          }
        }
        html += `</tr>`;
      }
  
      html += `
            </tbody>
          </table>
  
          <div style="text-align: center; margin-top: 30px;">
            <button onclick="location.href='/preference-form'" style="padding: 10px 20px; margin-right: 15px; border: none; background: #ccc; border-radius: 6px; font-weight: bold; cursor: pointer;">ğŸ” ë‹¤ì‹œí•˜ê¸°</button>
            <button onclick="saveAndGoToMyPage()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">ğŸ“¥ ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™</button>
          </div>
        </div>
      `;
  
      container.innerHTML = html;
    }
  
    async function saveAndGoToMyPage() {
      const userId = document.getElementById("userId").value;
      const meals = window.lastRecommendationResult;
  
      if (!meals || meals.length === 0) {
        alert("ì €ì¥í•  ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì¶”ì²œì„ ë°›ì•„ì£¼ì„¸ìš”.");
        return;
      }
  
      const payload = meals.map(m => ({
        userId: userId,
        time: m.time,
        rice: m.rice,
        soup: m.soup,
        side: m.side,
        totalCal: m.totalCal,
        day: m.day,
        similarity: m.similarity
      }));
  
      try {
        const res = await fetch("http://localhost:8081/save-recommend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
  
        if (res.ok) {
          window.location.href = "/mypage";
        } else {
          alert("ì‹ë‹¨ ì €ì¥ ì‹¤íŒ¨");
        }
      } catch (e) {
        console.error("ì €ì¥ ì‹¤íŒ¨:", e);
        alert("ì—ëŸ¬ ë°œìƒ");
      }
    }
  </script>
</body>
</html>
