<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë§ˆì´í˜ì´ì§€</title>
  <link rel="stylesheet" href="/css/mypage.css" />
</head>
<body>
  <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <header class="top-bar">
    <div class="logo-search">
      <a href="/main">
        <img src="/image/logo.png" alt="ë¡œê³ " class="logo-img" />
      </a>
      <input type="text" placeholder="ì°¾ëŠ” ìŒì‹ì´ ìˆìœ¼ì‹ ê°€ìš”?" class="search-input" />
    </div>
    <div class="header-buttons">
      <button class="diet-generate-btn">ì‹ë‹¨ ìƒì„±í•˜ê¸°</button>
    </div>
  </header>

  <!-- ë³¸ë¬¸ -->
  <main class="mypage-container">
    <!-- í”„ë¡œí•„ + ê·¸ë˜í”„ -->
    <section class="profile-chart-wrapper">
      <div class="profile-section">
        <div class="profile-top">
          <img th:src="@{${user.profile_img}}" alt="í”„ë¡œí•„" class="profile-img" />
          <div class="profile-info">
            <p><strong>ì´ë¦„:</strong> <span th:text="${userName}">ì´ë¦„</span></p>
            <p><strong>ë‚˜ì´:</strong> <span th:text="${userAge}">ë‚˜ì´</span></p>
            <p><strong>ì„±ë³„:</strong> <span th:text="${userSex}">ì„±ë³„</span></p>
          </div>
        </div>
        <div class="profile-buttons">
          <a href="/profile-edit" class="action-btn">ê°œì¸ì •ë³´ ë³€ê²½</a>
          <button type="button" class="action-btn" id="openModalBtn">ì˜¤ëŠ˜ ì²´ì¤‘ ë“±ë¡í•˜ê¸°</button>
        </div>
      </div>

      <div class="chart-section">
        <h4>ğŸ“ˆ ì²´ì¤‘ ì¶”ì„¸</h4>
        <canvas id="weightChart" width="1050" height="220"></canvas>
      </div>
    </section>

    <!-- ìš”ì¼ë³„ ì‹ë‹¨ ì¶”ì²œ -->
    <section class="diet-section">
      <p class="diet-title" th:text="'ì²´ì¤‘ê°ëŸ‰ì„ ì›í•˜ëŠ” ' + ${userName} + 'ë‹˜ì„ ìœ„í•œ ì¶”ì²œ ì‹ë‹¨!'">
        ì²´ì¤‘ê°ëŸ‰ì„ ì›í•˜ëŠ” 00ë‹˜ì„ ìœ„í•œ ì¶”ì²œ ì‹ë‹¨!
      </p>
      <div class="week-tabs">
        <div class="day-tab" data-day="SUN">SUN</div>
        <div class="day-tab" data-day="MON">MON</div>
        <div class="day-tab" data-day="TUE">TUE</div>
        <div class="day-tab" data-day="WED">WED</div>
        <div class="day-tab" data-day="THU">THU</div>
        <div class="day-tab" data-day="FRI">FRI</div>
        <div class="day-tab" data-day="SAT">SAT</div>
      </div>
      <div class="meal-cards">
        <div class="meal-card">
          <div class="meal-img-slider"></div>
          <p class="meal-text">ì•„ì¹¨</p>
        </div>
        <div class="meal-card">
          <div class="meal-img-slider"></div>
          <p class="meal-text">ì ì‹¬</p>
        </div>
        <div class="meal-card">
          <div class="meal-img-slider"></div>
          <p class="meal-text">ì €ë…</p>
        </div>
      </div>
    </section>

    <!-- ë¦¬ë·° ê¸°ë°˜ ì¸ê¸° ë©”ë‰´ - ë°¥ -->
    <section class="popular-menu">
      <h3>ğŸš ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì´ ì„ í˜¸í•œ ë°¥ë¥˜ TOP 3</h3>
      <div class="menu-card-container">
        <div class="menu-card" th:each="food : ${reviewRiceList}">
          <img th:src="@{${food.img}}" class="menu-img" />
          <div class="menu-info">
            <strong th:text="${food.name}"></strong>
            <p th:text="'ì—´ëŸ‰ ' + ${food.energy} + 'kcal | ë‹¨ë°±ì§ˆ ' + ${food.protein} + 'g | ì§€ë°© ' + ${food.province} + 'g'"></p>
            <p th:text="'í‰ì  â­' + ${#numbers.formatDecimal(food.avgScore, 1, 1)}"></p>
            <a th:href="@{'/food-detail/' + ${food.foodId}}" class="detail-link">ìƒì„¸ë©”ë‰´ ë³´ê¸° ></a>
          </div>
        </div>
      </div>
    </section>

    <!-- ë¦¬ë·° ê¸°ë°˜ ì¸ê¸° ë©”ë‰´ - ë°˜ì°¬ -->
    <section class="popular-menu">
      <h3>ğŸ¥— ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì´ ì„ í˜¸í•œ ë°˜ì°¬ë¥˜ TOP 3</h3>
      <div class="menu-card-container">
        <div class="menu-card" th:each="food : ${reviewSideList}">
          <img th:src="@{${food.img}}" class="menu-img" />
          <div class="menu-info">
            <strong th:text="${food.name}"></strong>
            <p th:text="'ì—´ëŸ‰ ' + ${food.energy} + 'kcal | ë‹¨ë°±ì§ˆ ' + ${food.protein} + 'g | ì§€ë°© ' + ${food.province} + 'g'"></p>
            <p th:text="'í‰ì  â­' + ${#numbers.formatDecimal(food.avgScore, 1, 1)}"></p>
            <a th:href="@{'/food-detail/' + ${food.foodId}}" class="detail-link">ìƒì„¸ë©”ë‰´ ë³´ê¸° ></a>
          </div>
        </div>
      </div>
    </section>

    <!-- ë¦¬ë·° ê¸°ë°˜ ì¸ê¸° ë©”ë‰´ - êµ­ -->
    <section class="popular-menu">
      <h3>ğŸ² ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì´ ì„ í˜¸í•œ êµ­ë¥˜ TOP 3</h3>
      <div class="menu-card-container">
        <div class="menu-card" th:each="food : ${reviewSoupList}">
          <img th:src="@{${food.img}}" class="menu-img" />
          <div class="menu-info">
            <strong th:text="${food.name}"></strong>
            <p th:text="'ì—´ëŸ‰ ' + ${food.energy} + 'kcal | ë‹¨ë°±ì§ˆ ' + ${food.protein} + 'g | ì§€ë°© ' + ${food.province} + 'g'"></p>
            <p th:text="'í‰ì  â­' + ${#numbers.formatDecimal(food.avgScore, 1, 1)}"></p>
            <a th:href="@{'/food-detail/' + ${food.foodId}}" class="detail-link">ìƒì„¸ë©”ë‰´ ë³´ê¸° ></a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- ê³ ì • ë²„íŠ¼ -->
  <div class="fixed-button-area">
    <form action="/start-diet" method="get">
      <button type="submit" class="icon-button">
        <img src="/image/icon1.png" alt="ì‹ë‹¨ ìƒì„±">
        <p>ì‹ë‹¨ ìƒì„±í•˜ê¸°</p>
      </button>
    </form>
    <a href="/calorie">
      <div class="icon-button">
        <img src="/image/icon2.png" alt="ì¹¼ë¡œë¦¬ ì²˜ë°©">
        <p>ì¹¼ë¡œë¦¬ ì²˜ë°©<br>ë°›ê¸°</p>
      </div>
    </a>
    <a href="healty-map">
      <div class="icon-button">
        <img src="/image/icon3.png" alt="ì¸ë°”ë”” ì°¾ê¸°">
        <p>ì¸ë°”ë”” ì¸¡ì •<br>ë³´ê±´ì†Œ ì°¾ê¸°</p>
      </div>
    </a>
    <a href="product-list">
      <div class="icon-button">
        <img src="/image/icon3.png" alt="ìƒí’ˆ ê²€ìƒ‰">
        <p>ìƒí’ˆì •ë³´<br>ê²€ìƒ‰í•˜ê¸°</p>
      </div>
    </a>
  </div>

  <!-- ì²´ì¤‘ ë“±ë¡ ëª¨ë‹¬ -->
  <div id="weightModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>ì˜¤ëŠ˜ì˜ ì²´ì¤‘ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</h2>
      <form action="/recordWeight" method="post">
        <input type="number" name="weight" step="0.1" placeholder="ì²´ì¤‘ (kg)" required />
        <button type="submit">ë“±ë¡</button>
      </form>
    </div>
  </div>

  <!-- JS -->
  <script src="http://cdn.jsdelivr.net/npm/chart.js"></script>
  <script th:inline="javascript">
    const records = /*[[${weightRecords}]]*/ [];
    const labels = records.map(r => new Date(r.recordedAt).toLocaleDateString());
    const weights = records.map(r => r.weight);
    const ctx = document.getElementById("weightChart").getContext("2d");
  
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'ì²´ì¤‘ (kg)',
          data: weights,
          borderColor: 'rgba(75, 192, 192, 1)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          fill: true,
          tension: 0.3,
          pointStyle: 'circle',
          pointRadius: 5,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            usePointStyle: true,
            labels: { usePointStyle: true }
          }
        },
        scales: {
          y: { beginAtZero: false }
        }
      }
    });
  
    // ëª¨ë‹¬ ì œì–´
    const modal = document.getElementById('weightModal');
    const openBtn = document.getElementById('openModalBtn');
    const closeBtn = document.querySelector('.modal .close');
    openBtn.onclick = () => modal.style.display = 'block';
    closeBtn.onclick = () => modal.style.display = 'none';
    window.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; }
  
    // âœ… ìš”ì¼ë³„ ì‹ë‹¨ ì˜ì—­
    const tabs = document.querySelectorAll(".day-tab");
    const mealCards = document.querySelectorAll(".meal-card");
    const mealsByDay = JSON.parse(/*[[${mealsByDay}]]*/ '{}');
  
    console.log("ğŸ“¦ mealsByDay ì „ì²´:", mealsByDay);
  
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        const meals = mealsByDay[tab.dataset.day];
  
        console.log(`ğŸ” ì„ íƒëœ ìš”ì¼: ${tab.dataset.day}`);
        console.log("ğŸ± í•´ë‹¹ ìš”ì¼ì˜ meals:", meals);
  
        if (meals) {
          mealCards.forEach((card, i) => {
            const meal = meals[i];
            console.log(`â¡ï¸ ${i}ë²ˆ ì‹ì‚¬:`, meal);
  
            const text = card.querySelector(".meal-text");
            const slider = card.querySelector(".meal-img-slider");
            slider.innerHTML = "";
  
            if (meal?.images?.length > 0) {
              meal.images.forEach(src => {
                const encodedSrc = encodeURI(src);  // âœ… ê²½ë¡œ ì¸ì½”ë”© ì²˜ë¦¬!
                console.log("ğŸ–¼ ì´ë¯¸ì§€ ê²½ë¡œ:", encodedSrc);
  
                const img = document.createElement("img");
                img.src = encodedSrc;
                img.className = "meal-slide";
                slider.appendChild(img);
              });
            } else {
              console.warn("âš ï¸ ì´ë¯¸ì§€ ì—†ìŒ:", meal);
            }
  
            if (text && meal?.name) {
              text.textContent = meal.name;
            }
          });
        } else {
          console.warn("âŒ meals ê°ì²´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ!");
        }
      });
    });
  
    const today = new Date();
    const dayNames = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
    const todayTab = document.querySelector(`.day-tab[data-day="${dayNames[today.getDay()]}"]`);
    if (todayTab) todayTab.click();
  </script>
  
  
</body>
</html>
