<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>맞춤형 식단 추천 설문</title>
  <link rel="stylesheet" href="/css/preference-form.css" />
</head>
<body>
  <h1>맞춤형 식단 추천을 위한 설문</h1>

  <form id="surveyForm">

    <!-- 👤 로그인 사용자 정보 hidden 처리 -->
    <input type="hidden" id="userId" th:value="${userId}">
    <input type="hidden" id="recomCal" th:value="${recomCal}">

    <!-- STEP 1 -->
    <div class="form-step active" id="step1">
      <h2>STEP 1: 식사 및 선호 재료</h2>

      <div class="form-group">
        <p>선호하는 밥 종류</p>
        <div class="checkbox-grid">
          <label><input type="checkbox" name="preferredRiceTypes" value="쌀밥"> 쌀밥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="잡곡밥"> 잡곡밥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="현미밥"> 현미밥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="흑미밥"> 흑미밥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="찰밥"> 찰밥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="차조밥"> 차조밥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="귀리밥"> 귀리밥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="오곡밥"> 오곡밥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="보리밥"> 보리밥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="검정콩밥"> 검정콩밥</label>
          <label><input type="checkbox" name="preferredRiceTypes" value="수수밥"> 수수밥</label>
        </div>
      </div>

      <div class="form-group">
        <p>선호하는 조리 방식</p>
        <div class="checkbox-grid">
          <label><input type="checkbox" name="userTags" value="국물요리"> 국물요리</label>
          <label><input type="checkbox" name="userTags" value="볶음요리"> 볶음요리</label>
          <label><input type="checkbox" name="userTags" value="조림요리"> 조림요리</label>
        </div>
      </div>

      <div class="form-group">
        <p>선호하는 재료</p>
        <div class="checkbox-grid">
          <label><input type="checkbox" name="userTags" value="소고기"> 소고기</label>
          <label><input type="checkbox" name="userTags" value="돼지고기"> 돼지고기</label>
          <label><input type="checkbox" name="userTags" value="닭고기"> 닭고기</label>
          <label><input type="checkbox" name="userTags" value="오리고기"> 오리고기</label>
          <label><input type="checkbox" name="userTags" value="감자"> 감자</label>
          <label><input type="checkbox" name="userTags" value="고구마"> 고구마</label>
          <label><input type="checkbox" name="userTags" value="계란"> 계란</label>
          <label><input type="checkbox" name="userTags" value="두부"> 두부</label>
          <label><input type="checkbox" name="userTags" value="콩"> 콩</label>
          <label><input type="checkbox" name="userTags" value="버섯"> 버섯</label>
          <label><input type="checkbox" name="userTags" value="느타리"> 느타리</label>
          <label><input type="checkbox" name="userTags" value="표고"> 표고</label>
          <label><input type="checkbox" name="userTags" value="양파"> 양파</label>
          <label><input type="checkbox" name="userTags" value="당근"> 당근</label>
          <label><input type="checkbox" name="userTags" value="오이"> 오이</label>
          <label><input type="checkbox" name="userTags" value="브로콜리"> 브로콜리</label>
          <label><input type="checkbox" name="userTags" value="양배추"> 양배추</label>
          <label><input type="checkbox" name="userTags" value="가지"> 가지</label>
          <label><input type="checkbox" name="userTags" value="애호박"> 애호박</label>
          <label><input type="checkbox" name="userTags" value="미역"> 미역</label>
          <label><input type="checkbox" name="userTags" value="멸치"> 멸치</label>
          <label><input type="checkbox" name="userTags" value="연근"> 연근</label>
          <label><input type="checkbox" name="userTags" value="우엉"> 우엉</label>
          <label><input type="checkbox" name="userTags" value="우거지"> 우거지</label>
          <label><input type="checkbox" name="userTags" value="새우"> 새우</label>
          <label><input type="checkbox" name="userTags" value="낙지"> 낙지</label>
          <label><input type="checkbox" name="userTags" value="문어"> 문어</label>
          <label><input type="checkbox" name="userTags" value="오징어"> 오징어</label>
          <label><input type="checkbox" name="userTags" value="굴"> 굴</label>
          <label><input type="checkbox" name="userTags" value="참치"> 참치</label>
        </div>
      </div>

      <div class="navigation">
        <button type="button" onclick="goToStep(2)">다음</button>
      </div>
    </div>

    <!-- STEP 2 -->
    <div class="form-step" id="step2">
      <h2>STEP 2: 기피 음식 및 칼로리 분배</h2>

      <div class="form-group">
        <p>기피하는 조리 특성</p>
        <div class="checkbox-grid">
          <label><input type="checkbox" name="dislikedTags" value="매운맛"> 매운맛</label>
          <label><input type="checkbox" name="dislikedTags" value="발효국"> 발효된 국물</label>
          <label><input type="checkbox" name="dislikedTags" value="고당"> 당분이 높은 음식</label>
          <label><input type="checkbox" name="dislikedTags" value="고지방"> 지방이 많은 음식</label>
          <label><input type="checkbox" name="dislikedTags" value="고칼로리"> 고칼로리 음식</label>
        </div>
      </div>

      <div class="form-group">
        <p>기피하는 재료</p>
        <div class="checkbox-grid">
          <!-- 같은 방식으로 반복 -->
          <label><input type="checkbox" name="dislikedTags" value="소고기"> 소고기</label>
          <label><input type="checkbox" name="dislikedTags" value="돼지고기"> 돼지고기</label>
          <label><input type="checkbox" name="dislikedTags" value="닭고기"> 닭고기</label>
          <label><input type="checkbox" name="dislikedTags" value="오리고기"> 오리고기</label>
          <label><input type="checkbox" name="dislikedTags" value="감자"> 감자</label>
          <label><input type="checkbox" name="dislikedTags" value="고구마"> 고구마</label>
          <label><input type="checkbox" name="dislikedTags" value="계란"> 계란</label>
          <label><input type="checkbox" name="dislikedTags" value="두부"> 두부</label>
          <label><input type="checkbox" name="dislikedTags" value="콩"> 콩</label>
          <label><input type="checkbox" name="dislikedTags" value="버섯"> 버섯</label>
          <label><input type="checkbox" name="dislikedTags" value="느타리"> 느타리</label>
          <label><input type="checkbox" name="dislikedTags" value="표고"> 표고</label>
          <label><input type="checkbox" name="dislikedTags" value="양파"> 양파</label>
          <label><input type="checkbox" name="dislikedTags" value="당근"> 당근</label>
          <label><input type="checkbox" name="dislikedTags" value="오이"> 오이</label>
          <label><input type="checkbox" name="dislikedTags" value="브로콜리"> 브로콜리</label>
          <label><input type="checkbox" name="dislikedTags" value="양배추"> 양배추</label>
          <label><input type="checkbox" name="dislikedTags" value="가지"> 가지</label>
          <label><input type="checkbox" name="dislikedTags" value="애호박"> 애호박</label>
          <label><input type="checkbox" name="dislikedTags" value="미역"> 미역</label>
          <label><input type="checkbox" name="dislikedTags" value="멸치"> 멸치</label>
          <label><input type="checkbox" name="dislikedTags" value="연근"> 연근</label>
          <label><input type="checkbox" name="dislikedTags" value="우엉"> 우엉</label>
          <label><input type="checkbox" name="dislikedTags" value="우거지"> 우거지</label>
          <label><input type="checkbox" name="dislikedTags" value="새우"> 새우</label>
          <label><input type="checkbox" name="dislikedTags" value="낙지"> 낙지</label>
          <label><input type="checkbox" name="dislikedTags" value="문어"> 문어</label>
          <label><input type="checkbox" name="dislikedTags" value="오징어"> 오징어</label>
          <label><input type="checkbox" name="dislikedTags" value="굴"> 굴</label>
          <label><input type="checkbox" name="dislikedTags" value="참치"> 참치</label>
        </div>
      </div>

      <div class="navigation">
        <button type="button" onclick="goToStep(1)">이전</button>
        <button type="button" onclick="goToStep(3)">다음</button>
      </div>
    </div>

    <!-- STEP 3 -->
    <div class="form-step" id="step3">
      <h2>STEP 3: 중요 영양 요소 + 칼로리 분배</h2>

      <div class="form-group">
        <p>단백질</p>
        <div class="checkbox-grid">
          <label><input type="radio" name="userTags_protein" value="저단백"> 저단백</label>
          <label><input type="radio" name="userTags_protein" value="중단백"> 중단백</label>
          <label><input type="radio" name="userTags_protein" value="고단백"> 고단백</label>
        </div>
      </div>

      <div class="form-group">
        <p>지방</p>
        <div class="checkbox-grid">
          <label><input type="radio" name="userTags_fat" value="저지방"> 저지방</label>
          <label><input type="radio" name="userTags_fat" value="중지방"> 중지방</label>
          <label><input type="radio" name="userTags_fat" value="고지방"> 고지방</label>
        </div>
      </div>

      <div class="form-group">
        <p>당류</p>
        <div class="checkbox-grid">
          <label><input type="radio" name="userTags_sugar" value="저당"> 저당</label>
          <label><input type="radio" name="userTags_sugar" value="중간당"> 중간당</label>
          <label><input type="radio" name="userTags_sugar" value="고당"> 고당</label>
        </div>
      </div>

      <div class="form-group">
        <p>칼로리</p>
        <div class="checkbox-grid">
          <label><input type="radio" name="userTags_calorie" value="저칼로리"> 저칼로리</label>
          <label><input type="radio" name="userTags_calorie" value="중간칼로리"> 중간칼로리</label>
          <label><input type="radio" name="userTags_calorie" value="고칼로리"> 고칼로리</label>
        </div>
      </div>

      <hr>

      <div class="form-group">
        <p>하루 칼로리 분배 비율 (%)</p>
        <label>아침:</label><input type="number" name="calRatioMorning" value="30" min="0" max="100"> %
        <label>점심:</label><input type="number" name="calRatioLunch" value="40" min="0" max="100"> %
        <label>저녁:</label><input type="number" name="calRatioEvening" value="30" min="0" max="100"> %
      </div>

      <div class="navigation">
        <button type="button" onclick="goToStep(2)">이전</button>
        <button type="submit">제출</button>
      </div>
    </div>
  </form>

  <!-- ✅ 추천 결과 출력 영역 -->
  <div id="resultArea" style="max-width: 1000px; margin: 40px auto;"></div>

  <script>
    function goToStep(stepNum) {
      document.querySelectorAll(".form-step").forEach(div => {
        div.classList.remove("active");
      });
      document.getElementById(`step${stepNum}`).classList.add("active");
    }
  
    document.getElementById("surveyForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const getCheckedValues = (name) => {
        return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);
      };

      const formData = new FormData(this);

      const getRatio = (name, defaultVal) => {
        const val = formData.get(name);
        return val === null || val === "" ? defaultVal : parseInt(val);
      };

      // ✅ 라디오 그룹에서 값 가져오기
      const getRadioValue = (name) => {
        const selected = document.querySelector(`input[name="${name}"]:checked`);
        return selected ? selected.value : null;
      };

      // ✅ userTags 조합 (체크박스 + 라디오값 포함)
      const userTags = [
        ...getCheckedValues("userTags"), // checkbox 방식 (요리방식, 재료 등)
        getRadioValue("userTags_protein"),
        getRadioValue("userTags_fat"),
        getRadioValue("userTags_sugar"),
        getRadioValue("userTags_calorie")
      ].filter(Boolean); // null/undefined 제거

      const data = {
        userId: document.getElementById("userId").value,
        recomCal: parseFloat(document.getElementById("recomCal").value),
        preferredRiceTypes: getCheckedValues("preferredRiceTypes"),
        userTags: userTags,
        dislikedTags: getCheckedValues("dislikedTags"),
        calRatioMorning: getRatio("calRatioMorning", 30),
        calRatioLunch: getRatio("calRatioLunch", 40),
        calRatioEvening: getRatio("calRatioEvening", 30)
      };

      console.log("📤 API로 보낼 데이터:", data);

      try {
        const res = await fetch("http://127.0.0.1:8000/recommend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        const result = await res.json();
        console.log("✅ 추천 결과:", result);

        window.lastRecommendationResult = result;
        window.currentUserId = data.userId;

        renderResults(result);
      } catch (err) {
        console.error("❌ 추천 실패:", err);
        alert("추천 요청 중 오류가 발생했습니다.");
      }
    });
  
    function renderResults(data) {
      const container = document.getElementById("resultArea");
  
      let html = `
        <div class="recommend-wrapper">
          <h2 class="recommend-title">🍱 추천 식단 결과</h2>
          <table class="recommend-table">
            <thead>
              <tr>
                <th>날짜</th>
                <th>아침</th>
                <th>점심</th>
                <th>저녁</th>
              </tr>
            </thead>
            <tbody>
      `;
  
      const days = Array.from(new Set(data.map(d => d.day))).sort((a, b) => a - b);
      const times = ["morning", "lunch", "dinner"];
  
      for (let day of days) {
        html += `<tr><td>${day}일차</td>`;
        for (let time of times) {
          const meal = data.find(m => m.day === day && m.time === time);
          if (meal) {
            html += `
              <td>
                <div><strong>밥:</strong> ${meal.rice}</div>
                <div><strong>국:</strong> ${meal.soup}</div>
                <div><strong>반찬:</strong> ${meal.side}</div>
                <div><strong>칼로리:</strong> ${meal.totalCal} kcal</div>
                <div><strong>유사도:</strong> ${meal.similarity}</div>
              </td>
            `;
          } else {
            html += `<td>-</td>`;
          }
        }
        html += `</tr>`;
      }
  
      html += `
            </tbody>
          </table>
  
          <div style="text-align: center; margin-top: 30px;">
            <button onclick="location.href='/preference-form'" style="padding: 10px 20px; margin-right: 15px; border: none; background: #ccc; border-radius: 6px; font-weight: bold; cursor: pointer;">🔁 다시하기</button>
            <button onclick="saveAndGoToMyPage()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">📥 마이페이지로 이동</button>
          </div>
        </div>
      `;
  
      container.innerHTML = html;
    }
  
    async function saveAndGoToMyPage() {
      const userId = document.getElementById("userId").value;
      const meals = window.lastRecommendationResult;
  
      if (!meals || meals.length === 0) {
        alert("저장할 식단이 없습니다. 먼저 추천을 받아주세요.");
        return;
      }
  
      const payload = meals.map(m => ({
        userId: userId,
        time: m.time,
        rice: m.rice,
        soup: m.soup,
        side: m.side,
        totalCal: m.totalCal,
        day: m.day,
        similarity: m.similarity
      }));
  
      try {
        const res = await fetch("http://localhost:8081/save-recommend", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
  
        if (res.ok) {
          window.location.href = "/mypage";
        } else {
          alert("식단 저장 실패");
        }
      } catch (e) {
        console.error("저장 실패:", e);
        alert("에러 발생");
      }
    }
  </script>
</body>
</html>
